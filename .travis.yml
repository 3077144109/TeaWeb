sudo: true
dist: trusty

services:
  - docker

before_install:
  - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  - docker images
  - docker pull $DOCKER_USERNAME/teaweb:build_new
  - docker images

jobs:
  include:
    - stage: "build"
      name: TeaWeb build master branch
      script:
        - "mkdir -p /tmp/build"
        - "docker run --rm -v /tmp/build/logs/:/build/logs/ -v /tmp/build/packages/:/build/packages/ -v `pwd`:/build/TeaWeb $DOCKER_USERNAME/teaweb:build_new --enable-release --enable-debug"
        - "ls -lah /tmp/build/"
        - "ls -lah /tmp/build/logs/"
        - "ls -lah /tmp/build/packages/"
        - "wget https://github.com/buildkite/github-release/releases/download/v1.0/github-release-linux-amd64 -O /tmp/git-release -q; chmod +x /tmp/git-release;"
        - >
          export GITHUB_RELEASE_TAG="This is a auto build release from travis";
          export GITHUB_RELEASE_REPOSITORY="$TRAVIS_REPO_SLUG";
          export GITHUB_RELEASE_ACCESS_TOKEN="$GIT_AUTHTOKEN";
          echo "Release commit: $TRAVIS_TAG"; export GITHUB_RELEASE_COMMIT="$TRAVIS_TAG";
          /tmp/git-release "Travis autobuild $TRAVIS_TAG" /tmp/build/packages/* /tmp/build/logs/*;
      if: branch = master